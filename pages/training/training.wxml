<view class="training-container">
  <view class="header">
    <text class="title">è®­ç»ƒè®¡åˆ’</text>
    <text class="subtitle">åˆ¶å®šå’Œè·Ÿè¸ªæ‚¨çš„è®­ç»ƒè®¡åˆ’</text>
  </view>

  <view class="tabs">
    <view class="tab {{activeTab === 'plan' ? 'active' : ''}}" bindtap="switchTab" data-tab="plan">
      <text>è®­ç»ƒè®¡åˆ’</text>
    </view>
    <view class="tab {{activeTab === 'execute' ? 'active' : ''}}" bindtap="switchTab" data-tab="execute">
      <text>æ‰§è¡Œè®­ç»ƒ</text>
    </view>
  </view>

  <!-- è®­ç»ƒè®¡åˆ’ Tab -->
  <view class="tab-content" wx:if="{{activeTab === 'plan'}}">
    <view class="form-container">
      <view class="form-title">åˆ›å»ºè®­ç»ƒè®¡åˆ’</view>
      
      <view class="form-item">
        <text class="label">è®¡åˆ’åç§°</text>
        <input class="input" placeholder="ä¾‹å¦‚ï¼šåŠ›é‡è®­ç»ƒã€è€åŠ›è®­ç»ƒ" model:value="{{planName}}" />
      </view>

      <view class="form-item">
        <text class="label">è®¡åˆ’æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰</text>
        <input class="input" type="number" placeholder="è¾“å…¥è®­ç»ƒæ—¶é•¿" model:value="{{planDuration}}" />
      </view>

      <view class="form-item">
        <text class="label">è®­ç»ƒé¡¹ç›®</text>
        <view class="exercise-input-container">
          <input class="input exercise-input" placeholder="æ·»åŠ è®­ç»ƒé¡¹ç›®" model:value="{{exerciseInput}}" />
          <view class="add-btn" bindtap="addExercise">
            <image src="../../assets/plus-white.svg"></image>
          </view>
          <view class="paste-btn" bindtap="showPasteExercises">
            <image src="../../assets/copy.svg"></image>
          </view>
        </view>
      </view>

      <!-- å·²æ·»åŠ çš„è®­ç»ƒé¡¹ç›®åˆ—è¡¨ -->
      <view class="exercises-list" wx:if="{{exercises.length > 0}}">
        <view class="exercise-item" wx:for="{{exercises}}" wx:key="index">
          <text>{{item}}</text>
          <view class="exercise-actions">
            <!-- ç¼–è¾‘å›¾æ ‡ -->
            <view class="edit-exercise" bindtap="editExercise" data-index="{{index}}">
              <text class="edit-text">âœ</text>
            </view>
            <!-- åˆ é™¤å›¾æ ‡ -->
            <view class="delete-exercise" bindtap="deleteExercise" data-index="{{index}}">
              <text>Ã—</text>
            </view>
          </view>
        </view>
      </view>

      <button class="submit-btn" bindtap="createPlan">åˆ›å»ºè®¡åˆ’</button>
    </view>

    <!-- å·²ä¿å­˜çš„è®­ç»ƒè®¡åˆ’åˆ—è¡¨ -->
    <view class="plans-list" wx:if="{{trainingPlans.length > 0}}">
      <view class="list-header">
        <text>å·²ä¿å­˜çš„è®­ç»ƒè®¡åˆ’</text>
      </view>
      
      <view class="plan-card" wx:for="{{trainingPlans}}" wx:key="id">
        <view class="card-header">
          <view class="card-title">{{item.name}}</view>
        </view>
        
        <view class="card-content">
          <view class="card-row">
            <text class="card-label">æ—¶é•¿ï¼š</text>
            <text class="card-value">{{item.duration}} åˆ†é’Ÿ</text>
          </view>
          <view class="card-row">
            <text class="card-label">é¡¹ç›®æ•°ï¼š</text>
            <text class="card-value">{{item.exercises.length}} ä¸ª</text>
          </view>
        </view>
        
        <view class="card-actions">
          <view class="action-btn view-btn" bindtap="viewPlanDetail" data-id="{{item.id}}">
            æŸ¥çœ‹è¯¦æƒ…
          </view>
          <view class="action-btn delete-btn" bindtap="deletePlan" data-id="{{item.id}}">
            åˆ é™¤
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- æ‰§è¡Œè®­ç»ƒ Tab -->
  <view class="tab-content" wx:if="{{activeTab === 'execute'}}">
    <view class="execute-container">
      <view class="form-container">
      
        <view class="form-item" wx:if="{{!onExecution}}">
          <view class="form-title">å¼€å§‹æ–°è®­ç»ƒ</view>
          <text class="label">é€‰æ‹©è®­ç»ƒè®¡åˆ’</text>
          <picker bindchange="selectTrainingPlan" value="{{selectedPlanIndex}}" range="{{trainingPlanNames}}" class="picker">
            <view class="picker-content">
              {{selectedPlanIndex >= 0 ? trainingPlanNames[selectedPlanIndex] : 'è¯·é€‰æ‹©è®­ç»ƒè®¡åˆ’'}}
              <view class="arrow">â–¼</view>
            </view>
          </picker>
        </view>
        <view wx:else class="plan-name">
          <text class="plan-name-text">{{selectedPlan.name}}</text>
        </view>

        <!-- è®¡æ—¶å™¨ -->
        <view class="timer-container" wx:if="{{selectedPlanIndex >= 0}}">
          <view class="timer">{{timerDisplay}}</view>
          <view class="timer-actions">
            <button class="timer-btn {{isTimerRunning ? 'pause-btn' : 'start-btn'}}" bindtap="toggleTimer">
              {{isTimerRunning ? 'æš‚åœ' : 'å¼€å§‹'}}
            </button>
            <button class="timer-btn reset-btn" bindtap="resetTimer">é‡ç½®</button>
          </view>
        </view>

        <!-- è®­ç»ƒå†…å®¹ -->
        <view class="training-content" wx:if="{{selectedPlanIndex >= 0}}">
          <text class="content-title">è®­ç»ƒå†…å®¹</text>
          <view class="exercise-checklist">
            <view class="exercise-check-item" wx:for="{{selectedPlan.exercises}}" wx:key="index">
              <checkbox checked="{{completedExercises[index]}}" bindtap="toggleExerciseComplete" data-index="{{index}}"></checkbox>
              <text class="exercise-name {{completedExercises[index] ? 'completed' : ''}}">{{item}}</text>
            </view>
          </view>
        </view>

        <!-- è®­ç»ƒåé¦ˆ -->
        <view class="form-item" wx:if="{{selectedPlanIndex >= 0}}">
          <text class="label">è®­ç»ƒåé¦ˆ</text>
          <textarea class="textarea" placeholder="è®°å½•ä½ çš„è®­ç»ƒæ„Ÿå—..." model:value="{{trainingFeedback}}"></textarea>
        </view>

        <button class="submit-btn" bindtap="saveTrainingRecord" wx:if="{{selectedPlanIndex >= 0}}">ä¿å­˜è®­ç»ƒè®°å½•</button>
      </view>

      <!-- è®­ç»ƒè®°å½•åˆ—è¡¨ -->
      <view class="training-records" wx:if="{{trainingRecords.length > 0}}">
        <view class="list-header">
          <text class="list-title">è®­ç»ƒè®°å½•</text>
          
          <!-- æ—¥æœŸé€‰æ‹©å™¨ -->
          <view class="filter-container">
            <picker mode="date" value="{{filterDate}}" bindchange="changeFilterDate" class="date-filter">
              <view class="filter-content">
                <text>ç­›é€‰: {{filterDate || 'å…¨éƒ¨æ—¥æœŸ'}}</text>
                <text class="filter-icon">ğŸ”</text>
              </view>
            </picker>
            <view class="clear-filter" wx:if="{{filterDate}}" bindtap="clearDateFilter">Ã—</view>
          </view>
        </view>
        
        <!-- æ— è®°å½•æç¤º -->
        <view class="no-records" wx:if="{{filteredRecords.length === 0 && filterDate}}">
          <text>{{filterDate}} æ²¡æœ‰è®­ç»ƒè®°å½•</text>
          <view class="clear-filter-btn" bindtap="clearDateFilter">æ¸…é™¤ç­›é€‰</view>
        </view>
        
        <view class="record-card" wx:for="{{filteredRecords}}" wx:key="id">
          <view class="card-header">
            <view class="card-title">{{item.planName}}</view>
            <view class="card-actions">
              <view class="icon-view" bindtap="viewRecordDetail" data-id="{{item.id}}">
                <view class="svg-icon">
                  <image src="../../assets/eye.svg"/>
                </view>
              </view>
              <view class="icon-delete" bindtap="deleteRecord" data-id="{{item.id}}">
                <view class="svg-icon">
                  <image src="../../assets/delete.svg"/>
                </view>
              </view>
            </view>
          </view>
          
          <view class="card-content">
            <view class="card-row">
              <view class="card-label">
                <image class="label-icon" src="../../assets/calendar.svg"></image>
                <text>æ—¥æœŸï¼š</text>
              </view>
              <text class="card-value">{{item.date}}</text>
            </view>
            <view class="card-row">
              <view class="card-label">
                <image class="label-icon" src="../../assets/clock.svg"></image>
                <text>æ—¶é•¿ï¼š</text>
              </view>
              <text class="card-value">{{item.duration}} åˆ†é’Ÿ</text>
            </view>
            <view class="card-row">
              <view class="card-label">
                <image class="label-icon" src="../../assets/circle-check.svg"></image>
                <text>å®Œæˆé¡¹ç›®ï¼š</text>
              </view>
              <text class="card-value">{{item.completedCount}}/{{item.totalCount}}</text>
            </view>
            <view class="card-feedback" wx:if="{{item.feedback}}">
              <view class="card-label">
                <text>åé¦ˆï¼š</text>
              </view>
              <text class="card-value">{{item.feedback}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- è®¡åˆ’è¯¦æƒ…å¼¹çª— -->
  <view class="modal" wx:if="{{showPlanDetail}}">
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">{{currentPlan.name}}</text>
        <view class="close-btn" bindtap="closePlanDetail">Ã—</view>
      </view>
      
      <view class="modal-body">
        <view class="detail-item">
          <text class="detail-label">è®­ç»ƒæ—¶é•¿ï¼š</text>
          <text class="detail-value">{{currentPlan.duration}} åˆ†é’Ÿ</text>
        </view>
        
        <view class="detail-item">
          <text class="detail-label">è®­ç»ƒé¡¹ç›®ï¼š</text>
          <view class="detail-exercises">
            <view class="detail-exercise" wx:for="{{currentPlan.exercises}}" wx:key="index">
              <text>{{index + 1}}. {{item}}</text>
            </view>
          </view>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="modal-btn" bindtap="closePlanDetail">å…³é—­</button>
      </view>
    </view>
  </view>

  <!-- æ·»åŠ ç¼–è¾‘è®­ç»ƒé¡¹ç›®çš„å¼¹çª— -->
  <view class="modal" wx:if="{{showEditExercise}}">
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">ç¼–è¾‘è®­ç»ƒé¡¹ç›®</text>
        <view class="close-btn" bindtap="closeEditExercise">Ã—</view>
      </view>
      
      <view class="modal-body">
        <view class="form-item">
          <input class="input" model:value="{{editExerciseContent}}" focus="{{true}}" />
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="modal-btn cancel-btn" bindtap="closeEditExercise">å–æ¶ˆ</button>
        <button class="modal-btn" bindtap="saveEditExercise">ä¿å­˜</button>
      </view>
    </view>
  </view>

  <!-- ç²˜è´´è®­ç»ƒé¡¹ç›®å¼¹çª— -->
  <view class="modal" wx:if="{{showPasteExercises}}">
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">å¤åˆ¶è®­ç»ƒé¡¹ç›®</text>
        <view class="close-btn" bindtap="closePasteExercises">Ã—</view>
      </view>
      
      <view class="modal-body">
        <view class="form-item">
          <textarea class="textarea paste-textarea" placeholder="æ¯è¡Œè¾“å…¥ä¸€ä¸ªè®­ç»ƒé¡¹ç›®..." model:value="{{pasteExercisesContent}}" focus="{{true}}" maxlength="5000"></textarea>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="modal-btn" bindtap="addPastedExercises">å¤åˆ¶å¹¶æ·»åŠ </button>
        <button class="modal-btn cancel-btn" bindtap="closePasteExercises">å–æ¶ˆ</button>
      </view>
    </view>
  </view>

  <!-- è®­ç»ƒè®°å½•è¯¦æƒ…å¡ç‰‡å¼¹çª— -->
  <view class="detail-card-overlay" wx:if="{{showRecordDetail}}" bindtap="closeRecordDetail">
    <view class="detail-card" catchtap="stopPropagation">

      <!-- å¡ç‰‡å¤´éƒ¨ -->
      <view class="detail-card-header">
        <view class="mountain-bg">
          <image src="../../assets/training.svg" />
        </view>
        <view class="header-content">
          <text class="header-subtitle">è®­ç»ƒè®°å½•</text>
          <text class="detail-card-title">{{currentRecord.planName}}</text>
        </view>
      </view>

      <view class="achievement-badge"><text>è®­ç»ƒå®Œæˆ</text></view>
      <view class="detail-card-content">
        <!-- è¯¦æƒ…ç½‘æ ¼ -->
        <view class="details-grid">
          <view class="detail-item">
            <view class="detail-label">
              <image class="label-icon" src="../../assets/calendar.svg"></image>
              <text>æ—¥æœŸ</text>
            </view>
            <text class="detail-value">{{currentRecord.date}}</text>
          </view>

          <view class="detail-item">
            <view class="detail-label">
              <image class="label-icon" src="../../assets/clock.svg"></image>
              <text>æ—¶é•¿</text>
            </view>
            <text class="detail-value">{{currentRecord.duration}} åˆ†é’Ÿ</text>
          </view>

          <view class="detail-item detail-item-full">
            <view class="detail-label">
              <image class="label-icon" src="../../assets/circle-check.svg"></image>
              <text>å®Œæˆé¡¹ç›® ({{currentRecord.completedCount}}/{{currentRecord.totalCount}})</text>
            </view>
            <view class="detail-exercise-list" wx:if="{{currentRecord.exercises && currentRecord.exercises.length > 0}}">
              <view class="detail-exercise-item {{currentRecord.completionStatus[index] ? 'completed' : ''}}" wx:for="{{currentRecord.exercises}}" wx:key="index">
                <text class="list-dot">â€¢ </text>
                <text class="exercise-text">{{item}}</text>
              </view>
            </view>
            <view wx:else>
              <text class="detail-value">{{currentRecord.completedCount}}/{{currentRecord.totalCount}}</text>
            </view>
          </view>

          <view class="detail-item detail-item-full" wx:if="{{currentRecord.feedback}}">
            <view class="detail-label">
              <image class="label-icon" src="../../assets/message-square.svg"></image>
              <text>è®­ç»ƒåé¦ˆ</text>
            </view>
            <text class="detail-value">{{currentRecord.feedback}}</text>
          </view>
        </view>

        <!-- ä¿å­˜æŒ‰é’® -->
        <button class="save-card-btn" bindtap="callSaveTrainingCard">
          <image src="../../assets/download.svg"></image>
          <text>ä¿å­˜åˆ†äº«å¡ç‰‡</text>
        </button>
      </view>

      <!-- åº•éƒ¨æ–‡å­— -->
      <view class="detail-card-footer">
        <text class="footer-text">åšæŒè®­ç»ƒï¼Œä¿æŒå¥åº·</text>
      </view>
    </view>
  </view>

  <!-- ç”¨äºç”Ÿæˆå›¾ç‰‡çš„éšè—canvas -->
  <canvas type="2d" id="trainingCardCanvas" style="width: 600px; height: 800px; position: fixed; left: -2000px; top: -2000px;"></canvas>
</view> 