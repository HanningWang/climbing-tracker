<view class="routes-container">
  <view class="header">
    <text class="title">åˆ·çº¿è®°å½•</text>
    <text class="subtitle">è®°å½•æ‚¨çš„æ”€å²©è·¯çº¿å’Œæˆç»©</text>
  </view>

  <view class="tab-container">
    <view class="tab {{activeTab === 'normal' ? 'active' : ''}}" bindtap="switchTab" data-tab="normal">æ™®é€šåˆ·çº¿</view>
    <view class="tab {{activeTab === 'game' ? 'active' : ''}}" bindtap="switchTab" data-tab="game">åˆ·çº¿æ¸¸æˆ</view>
  </view>

  <view class="form-container" wx:if="{{activeTab === 'normal'}}">
    <view class="form-title">è®°å½•åˆ·çº¿</view>
    
    <view class="form-item">
      <text class="label">æ”€å²©ç±»å‹</text>
      <picker bindchange="bindTypeChange" value="{{typeIndex}}" range="{{typeArray}}" class="picker">
        <view class="picker-content">
          {{typeArray[typeIndex]}}
          <view class="arrow">â–¼</view>
        </view>
      </picker>
    </view>

    <!-- å½“æ”€å²©ç±»å‹ä¸æ˜¯é€Ÿåº¦æ—¶æ‰æ˜¾ç¤ºéš¾åº¦é€‰æ‹©å™¨ -->
    <view class="form-item" wx:if="{{typeArray[typeIndex] !== 'é€Ÿåº¦'}}">
      <text class="label">éš¾åº¦</text>
      <picker bindchange="bindDifficultyChange" value="{{difficultyIndex}}" range="{{difficultyArray}}" class="picker">
        <view class="picker-content">
          {{difficultyArray[difficultyIndex]}}
          <view class="arrow">â–¼</view>
        </view>
      </picker>
    </view>

    <view class="form-item">
      <text class="label">æ•°é‡</text>
      <input class="input" type="number" placeholder="è¾“å…¥æ•°é‡" model:value="{{quantity}}" />
    </view>

    <button class="add-btn" bindtap="addToList">æ·»åŠ åˆ°åˆ—è¡¨</button>

    <!-- åˆ—è¡¨æ˜¾ç¤º -->
    <view class="route-list" wx:if="{{routesList.length > 0}}">
      <view class="list-header">
        <view class="list-col">ç±»å‹</view>
        <view class="list-col">éš¾åº¦</view>
        <view class="list-col">æ•°é‡</view>
        <view class="list-col">æ“ä½œ</view>
      </view>
      <view class="list-item" wx:for="{{routesList}}" wx:key="index">
        <view class="list-col">{{item.type}}</view>
        <view class="list-col">{{item.difficulty}}</view>
        <view class="list-col">
          <view class="quantity-control">
            <text class="quantity-btn" bindtap="decreaseQuantity" data-index="{{index}}">-</text>
            <text class="quantity-value">{{item.quantity}}</text>
            <text class="quantity-btn" bindtap="increaseQuantity" data-index="{{index}}">+</text>
          </view>
        </view>
        <view class="list-col">
          <view class="delete-icon" bindtap="deleteListItem" data-index="{{index}}">
            <view class="svg-icon">
              <image src="../../assets/delete.svg"/>
            </view>
          </view>
        </view>
      </view>
    </view>

    <view class="form-item">
      <text class="label">åœ°ç‚¹</text>
      <input class="input" placeholder="æ”€å²©é¦†æˆ–å²©åœºåç§°" model:value="{{location}}" />
    </view>

    <view class="form-item">
      <text class="label">æ—¥æœŸ</text>
      <picker mode="date" value="{{date}}" bindchange="bindDateChange" class="picker">
        <view class="picker-content">
          {{date || 'yyyy/mm/dd'}}
          <text class="calendar-icon">ğŸ“…</text>
        </view>
      </picker>
    </view>

    <view class="form-item">
      <text class="label">æ€»è®­ç»ƒæ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰</text>
      <input class="input" type="number" placeholder="è¾“å…¥è®­ç»ƒæ—¶é—´" model:value="{{trainingTime}}" />
    </view>

    <view class="button-group">
      <button class="save-btn" bindtap="saveRecord">ä¿å­˜è®°å½•</button>
      <button class="clear-btn" bindtap="clearForm">æ¸…ç©ºè¡¨å•</button>
    </view>
  </view>

  <view class="game-container" wx:if="{{activeTab === 'game'}}">
    <view wx:if="{{!isGameRunning}}">
      <view class="game-title">åˆ·çº¿æ¸¸æˆ</view>
      
      <view class="form-item">
        <text class="label">æ”€å²©åœ°ç‚¹</text>
        <input class="input" placeholder="æ”€å²©é¦†æˆ–å²©åœºåç§°" model:value="{{gameLocation}}" />
      </view>
      
      <view class="form-item">
        <text class="label">æ”€å²©ç±»å‹</text>
        <picker bindchange="bindGameTypeChange" value="{{gameTypeIndex}}" range="{{gameTypeArray}}" class="picker">
          <view class="picker-content">
            {{gameTypeArray[gameTypeIndex]}}
            <view class="arrow">â–¼</view>
          </view>
        </picker>
      </view>
      
      <view class="form-item">
        <text class="label">æ¸¸æˆæ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰</text>
        <input class="input" type="number" placeholder="è¾“å…¥æ¸¸æˆæ—¶é•¿" model:value="{{gameDuration}}" />
      </view>
      
      <view class="form-item">
        <text class="label">å‡ºæ‰‹æ¬¡æ•°</text>
        <input class="input" type="number" placeholder="è¾“å…¥å‡ºæ‰‹æ¬¡æ•°" model:value="{{gameAttempts}}" />
      </view>
      
      <button class="game-start-btn" bindtap="startGame">å¼€å§‹æ¸¸æˆ ({{gameDuration}}åˆ†é’Ÿ)</button>
    </view>
    
    <view wx:else class="game-running-container">
      <view class="game-header">
        <view class="game-timer">
          <image src="../../assets/timer-l.svg"></image>
          {{gameTimeDisplay}}
        </view>
        <view class="game-attempts">
          <text>å·²å‡ºæ‰‹: </text>
          <text class="game-attempts-number">{{gameRoutes.length}}/{{gameAttempts}}</text>
        </view>
        <view class="game-location-info">{{gameLocation}} - {{gameTypeArray[gameTypeIndex]}}</view>
      </view>
      
      <view class="difficulty-grid">
        <view wx:if="{{gameTypeArray[gameTypeIndex] === 'æŠ±çŸ³'}}" class="difficulty-grid-bouldering">
          <view class="difficulty-item" wx:for="{{boulderingDifficulties}}" 
                wx:key="*this" wx:for-index="idx">
            <view class="difficulty-btn" bindtap="addGameRoute" data-difficulty="{{item}}" data-success="true">
              {{item}}
            </view>
            <view class="difficulty-fail-btn" bindtap="addGameRoute" data-difficulty="{{item}}" data-success="false">
              <text class="fail-icon">Ã—</text>
            </view>
          </view>
        </view>
        
        <view wx:else class="difficulty-grid-sport">
          <view class="difficulty-item" wx:for="{{sportDifficulties}}" 
                wx:key="*this" wx:for-index="idx">
            <view class="difficulty-btn" bindtap="addGameRoute" data-difficulty="{{item}}" data-success="true">
              {{item}}
            </view>
            <view class="difficulty-fail-btn" bindtap="addGameRoute" data-difficulty="{{item}}" data-success="false">
              <text class="fail-icon">Ã—</text>
            </view>
          </view>
        </view>
      </view>

      <!-- æ·»åŠ ç»Ÿè®¡ä¿¡æ¯ -->
      <view class="game-stats">
        <view class="stat-item">
          <text class="stat-label">æ€»åˆ†:</text>
          <text class="stat-value">{{gameScore}}</text>
        </view>
        <view class="stat-item">
          <text class="stat-label">å®Œæˆ:</text>
          <text class="stat-value success">{{gameSuccessCount}}</text>
        </view>
        <view class="stat-item">
          <text class="stat-label">æœªå®Œæˆ:</text>
          <text class="stat-value fail">{{gameFailCount}}</text>
        </view>
      </view>
      
      <!-- å°è¯•è®°å½• -->
      <view class="game-routes-list" wx:if="{{gameRoutes.length > 0}}">
        <view class="game-routes-header">
          <text>å°è¯•è®°å½•</text>
        </view>
        <view class="game-route-header">
          <text class="game-route-count-header">æ¬¡æ•°</text>
          <text class="game-route-time-header">å‰©ä½™æ—¶é—´</text>
          <text class="game-route-difficulty-header">éš¾åº¦</text>
          <text class="game-route-status-header">ç»“æœ</text>
        </view>
        <view class="game-route-item" wx:for="{{gameRoutes}}" wx:key="timestamp" wx:for-index="idx">
          <text class="game-route-count">{{idx + 1}}</text>
          <text class="game-route-time">{{item.gameTime}}</text>
          <text class="game-route-difficulty">{{item.difficulty}}</text>
          <text class="game-route-status {{item.success ? 'success' : 'fail'}}">{{item.success ? 'å®Œæˆ' : 'æœªå®Œæˆ'}}</text>
        </view>
      </view>
      
      <!-- æ¸¸æˆæŒ‰é’® - ç§»åˆ°isGameRunningå†…éƒ¨ -->
      <view class="game-buttons">
        <button class="game-end-btn" bindtap="endGame">ç»“æŸæ¸¸æˆ</button>
        <button class="game-cancel-btn" bindtap="cancelGame">å–æ¶ˆæ¸¸æˆ</button>
      </view>
    </view>
  </view>

  <!-- æ™®é€šåˆ·çº¿è®°å½• - ä»…åœ¨æ™®é€šåˆ·çº¿æ ‡ç­¾é¡µæ˜¾ç¤º -->
  <view class="history-container" wx:if="{{activeTab === 'normal'}}">
    <view class="history-header">
      <text>åˆ·çº¿è®°å½•</text>
      <view class="filter-container">
        <picker mode="date" value="{{filterDate}}" bindchange="bindFilterDateChange" class="date-filter">
          <view class="filter-content">
            <text>ç­›é€‰: {{filterDate || 'å…¨éƒ¨æ—¥æœŸ'}}</text>
            <text class="filter-icon">ğŸ”</text>
          </view>
        </picker>
        <view class="clear-filter" wx:if="{{filterDate}}" bindtap="clearDateFilter">Ã—</view>
      </view>
    </view>

    <view class="record-card" wx:for="{{filteredRecords}}" wx:key="id" wx:if="{{!item.isGame}}">
      <view class="card-header">
        <view class="card-location-title">{{item.location}}</view>
        <view class="card-actions">
          <view class="icon-view" bindtap="viewRecordDetail" data-id="{{item.id}}">
            <view class="svg-icon">
              <image src="../../assets/eye.svg"/>
            </view>
          </view>
          <view class="icon-delete" bindtap="deleteRecord" data-id="{{item.id}}">
            <view class="svg-icon">
              <image src="../../assets/delete.svg"/>
            </view>
          </view>
        </view>
      </view>
      
      <view class="card-content">
        <view class="card-item">
          <text class="card-label">æ—¶é—´:</text>
          <text class="card-value">{{item.date}}</text>
        </view>
        <view class="card-item">
          <text class="card-label">æ€»è®­ç»ƒæ—¶é—´:</text>
          <text class="card-value">{{item.trainingTime}}åˆ†é’Ÿ</text>
        </view>
        <view class="card-item">
          <text class="card-label">è®°å½•æ•°:</text>
          <text class="card-value">{{item.routes.length}}æ¡</text>
        </view>
      </view>
    </view>
    
    <!-- æ·»åŠ æ— è®°å½•æç¤º -->
    <view class="no-records" wx:if="{{filteredRecords.length === 0 && filterDate}}">
      <text>{{filterDate}} æ²¡æœ‰åˆ·çº¿è®°å½•</text>
      <view class="clear-filter-btn" bindtap="clearDateFilter">æ¸…é™¤ç­›é€‰</view>
    </view>
  </view>

  <!-- æ¸¸æˆè®°å½• - ä»…åœ¨æ¸¸æˆæ ‡ç­¾é¡µæ˜¾ç¤º -->
  <view class="history-container" wx:if="{{activeTab === 'game'}}">
    <view class="history-header">
      <text>æ¸¸æˆè®°å½•</text>
      <view class="filter-container">
        <picker mode="date" value="{{gameFilterDate}}" bindchange="bindGameFilterDateChange" class="date-filter">
          <view class="filter-content">
            <text>ç­›é€‰: {{gameFilterDate || 'å…¨éƒ¨æ—¥æœŸ'}}</text>
            <text class="filter-icon">ğŸ”</text>
          </view>
        </picker>
        <view class="clear-filter" wx:if="{{gameFilterDate}}" bindtap="clearGameDateFilter">Ã—</view>
      </view>
    </view>

    <view class="record-card" wx:for="{{filteredGameRecords}}" wx:key="id">
      <view class="card-header">
        <view class="card-location-title">{{item.location}}</view>
        <view class="card-actions">
          <view class="icon-view" bindtap="viewGameRecordDetail" data-id="{{item.id}}">
            <view class="svg-icon">
              <image src="../../assets/eye.svg"/>
            </view>
          </view>
          <view class="icon-delete" bindtap="deleteGameRecord" data-id="{{item.id}}">
            <view class="svg-icon">
              <image src="../../assets/delete.svg"/>
            </view>
          </view>
        </view>
      </view>
      
      <view class="card-content">
        <view class="card-item">
          <text class="card-label">æ—¶é—´:</text>
          <text class="card-value">{{item.date}}</text>
        </view>
        <view class="card-item">
          <text class="card-label">æ¸¸æˆæ—¶é•¿:</text>
          <text class="card-value">{{item.actualGameTime || item.gameElapsedTime}}åˆ†é’Ÿ</text>
        </view>
        <view class="card-item">
          <text class="card-label">æ€»åˆ†:</text>
          <text class="card-value">{{item.gameScore}}åˆ†</text>
        </view>
        <view class="card-item">
          <text class="card-label">å®Œæˆç‡:</text>
          <text class="card-value">{{item.formattedCompletionRate}}</text>
        </view>
      </view>
    </view>
    
    <!-- æ·»åŠ æ— è®°å½•æç¤º -->
    <view class="no-records" wx:if="{{filteredGameRecords.length === 0 && gameFilterDate}}">
      <text>{{gameFilterDate}} æ²¡æœ‰æ¸¸æˆè®°å½•</text>
      <view class="clear-filter-btn" bindtap="clearGameDateFilter">æ¸…é™¤ç­›é€‰</view>
    </view>
  </view>

  <!-- æ™®é€šè®°å½•è¯¦æƒ…å¡ç‰‡å¼¹çª— -->
  <view class="detail-card-overlay" wx:if="{{showDetailCard}}" bindtap="closeDetailCard">
    <view class="detail-card" catchtap="stopPropagation">
      <view class="detail-card-header">
        <text class="detail-card-title">åˆ·çº¿è®°å½•è¯¦æƒ…</text>
        <view class="close-btn" bindtap="closeDetailCard">Ã—</view>
      </view>
      
      <view class="detail-card-content">
        <view class="detail-item">
          <text class="detail-title">{{currentCard.location}}</text>
        </view>
        
        <view class="detail-item">
          <text class="detail-label">æ—¥æœŸï¼š</text>
          <text class="detail-value">{{currentCard.date}}</text>
        </view>
        
        <view class="detail-item">
          <text class="detail-label">è®­ç»ƒæ—¶é—´ï¼š</text>
          <text class="detail-value">{{currentCard.trainingTime}} åˆ†é’Ÿ</text>
        </view>
        
        <view class="detail-routes">
          <text class="detail-label">è·¯çº¿è®°å½•ï¼š</text>
          <view class="detail-routes-list">
            <view class="detail-route-item" wx:for="{{currentCard.routes}}" wx:key="index">
              <text class="detail-route-type">{{item.type}}</text>
              <text class="detail-route-difficulty">{{item.difficulty}}</text>
              <text class="detail-route-quantity">x {{item.quantity}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- æ¸¸æˆè®°å½•è¯¦æƒ…å¡ç‰‡å¼¹çª— -->
  <view class="detail-card-overlay" wx:if="{{showGameDetailCard}}" bindtap="closeGameDetailCard">
    <view class="detail-card" catchtap="stopPropagation">
      <view class="detail-card-header">
        <text class="detail-card-title">æ¸¸æˆè®°å½•è¯¦æƒ…</text>
        <view class="close-btn" bindtap="closeGameDetailCard">Ã—</view>
      </view>
      
      <view class="detail-card-content">
        <view class="detail-item">
          <text class="detail-title">{{currentGameCard.location}}</text>
        </view>
        
        <view class="detail-item">
          <text class="detail-label">æ—¥æœŸï¼š</text>
          <text class="detail-value">{{currentGameCard.date}}</text>
        </view>
        
        <view class="detail-item">
          <text class="detail-label">æ¸¸æˆç±»å‹ï¼š</text>
          <text class="detail-value">{{currentGameCard.gameType}}</text>
        </view>
        
        <view class="detail-item">
          <text class="detail-label">æ¸¸æˆæ—¶é•¿ï¼š</text>
          <text class="detail-value">{{currentGameCard.actualGameTime || currentGameCard.gameElapsedTime}} åˆ†é’Ÿ</text>
        </view>
        
        <view class="detail-item">
          <text class="detail-label">æ€»åˆ†ï¼š</text>
          <text class="detail-value">{{currentGameCard.gameScore}} åˆ†</text>
        </view>
        
        <view class="detail-item">
          <text class="detail-label">å®Œæˆç‡ï¼š</text>
          <text class="detail-value">{{currentGameCard.formattedCompletionRate}}</text>
        </view>
        
        <view class="detail-game-routes" wx:if="{{currentGameCard.gameRoutes.length > 0}}">
          <text class="detail-label">å°è¯•è®°å½•ï¼š</text>
          <view class="detail-game-routes-list">
            <view class="detail-game-route-header">
              <text class="detail-game-route-difficulty-header">éš¾åº¦</text>
              <text class="detail-game-route-status-header">ç»“æœ</text>
            </view>
            <view class="detail-game-route-item" wx:for="{{currentGameCard.gameRoutes}}" wx:key="timestamp">
              <text class="detail-game-route-difficulty">{{item.difficulty}}</text>
              <text class="detail-game-route-status {{item.success ? 'success' : 'fail'}}">{{item.success ? 'å®Œæˆ' : 'æœªå®Œæˆ'}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>
</view> 